<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Keeper (Flat CSV Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .page { display: none; }
        .page.active { display: block; }
        nav button.active { background-color: #4f46e5; /* Tailwind indigo-600 */ color: white; }
        nav button:not(.active):hover { background-color: #6366f1; /* Tailwind indigo-500 */ color: white; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }

        input[type="text"], input[type="number"], input[type="email"], input[type="password"], textarea, select {
            @apply block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm;
        }
        label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        #messageBar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #messageBar.success { background-color: #28a745; }
        #messageBar.error { background-color: #dc3545; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="appLoader" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-12 w-12 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-lg font-semibold text-indigo-600">Loading Recipes...</p>
        </div>
    </div>

    <nav class="bg-indigo-700 shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="font-bold text-xl text-white">Recipe Keeper (Flat CSV)</span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <button data-page="recipesPage" class="nav-button px-3 py-2 rounded-md text-sm font-medium text-indigo-200 hover:text-white hover:bg-indigo-600">Recipes</button>
                        <button data-page="weekMenuPage" class="nav-button px-3 py-2 rounded-md text-sm font-medium text-indigo-200 hover:text-white hover:bg-indigo-600">Week Menu</button>
                        <button data-page="groceriesPage" class="nav-button px-3 py-2 rounded-md text-sm font-medium text-indigo-200 hover:text-white hover:bg-indigo-600">Groceries</button>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="mobileMenuButton" class="bg-indigo-700 inline-flex items-center justify-center p-2 rounded-md text-indigo-200 hover:text-white hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-indigo-700 focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="md:hidden" id="mobile-menu" style="display: none;">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <button data-page="recipesPage" class="nav-button mobile-nav-button block px-3 py-2 rounded-md text-base font-medium text-indigo-200 hover:text-white hover:bg-indigo-600 w-full text-left">Recipes</button>
                <button data-page="weekMenuPage" class="nav-button mobile-nav-button block px-3 py-2 rounded-md text-base font-medium text-indigo-200 hover:text-white hover:bg-indigo-600 w-full text-left">Week Menu</button>
                <button data-page="groceriesPage" class="nav-button mobile-nav-button block px-3 py-2 rounded-md text-base font-medium text-indigo-200 hover:text-white hover:bg-indigo-600 w-full text-left">Groceries</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div id="recipesPage" class="page p-4 space-y-6">
            <h2 class="text-3xl font-bold text-gray-900">My Recipes</h2>
            <div class="mb-4 p-4 bg-blue-100 border border-blue-300 text-blue-700 rounded-md">
                <p class="text-sm">Recipes are loaded from a CSV file. To add or edit recipes, please modify the source CSV file directly.</p>
                <p class="text-sm mt-1">Attempting to load CSV from: <code id="csvUrlDisplay" class="text-xs bg-blue-200 p-1 rounded break-all"></code></p>
                 <p class="text-xs mt-1 text-red-600 font-semibold">If recipes don't load, ensure the URL above is correct and the CSV file is publicly accessible and follows the specified wide format.</p>
            </div>
            <div id="recipeListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 custom-scrollbar">
                </div>
        </div>

        <div id="weekMenuPage" class="page p-4 space-y-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-900">Week Menu</h2>
                <div class="mt-4 sm:mt-0">
                    <label for="numDays" class="mr-2">Number of Days:</label>
                    <select id="numDays" class="p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="1">1</option> <option value="2">2</option> <option value="3">3</option>
                        <option value="4">4</option> <option value="5" selected>5</option> <option value="6">6</option>
                        <option value="7">7</option>
                    </select>
                </div>
            </div>
            <div id="weekMenuDaysContainer" class="space-y-8">
                </div>
             <button id="generateGroceriesFromMenuBtn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">Update & View Groceries List</button>
        </div>

        <div id="groceriesPage" class="page p-4">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Groceries List</h2>
            <div id="groceriesListContainer" class="bg-white p-6 rounded-lg shadow">
                </div>
        </div>
    </main>

    <div id="messageBar"></div>

    <script type="module">
        // --- CONFIGURATION ---
        const RECIPE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSdPSiY37PZmzEUFdPqOWqU7c_8TdK0CXdgIcnxYT08KlYcZzJ3nuhLbBxdfTgZwAGu4mGXoJrgQecp/pub?gid=0&single=true&output=csv';
        const WEEK_MENU_LOCALSTORAGE_KEY = 'recipeAppWeekMenu_flat_csv';
        const MAX_INGREDIENTS = 15; // Max number of ingredient blocks in CSV
        const MAX_PROCEDURE_STEPS = 20; // Max number of procedure steps in CSV

        // --- GLOBAL STATE ---
        let recipes = []; 
        let weekMenu = { numDays: 5, days: {} }; 
        const dayNames = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const mealTypes = ["breakfast", "lunch", "dinner"];
        
        async function initializeAppState() {
            document.getElementById('csvUrlDisplay').textContent = RECIPE_CSV_URL;
            if (RECIPE_CSV_URL === 'YOUR_CSV_FILE_URL_HERE') { // Redundant check now, but good practice
                showMessage("Configuration needed: Please update RECIPE_CSV_URL in the HTML file.", "error", 10000);
                document.getElementById('appLoader').style.display = 'none'; 
                showPage('recipesPage'); 
                renderRecipeList(); 
                return;
            }
            await loadRecipesFromCSV();
            loadWeekMenuFromLocalStorage();
            
            setupNumDaysListener();
            renderWeekMenuUI(); 
            
            document.getElementById('appLoader').style.display = 'none'; 
            showPage('recipesPage'); 
        }

        // --- NAVIGATION ---
        const navButtons = document.querySelectorAll('.nav-button');
        const pages = document.querySelectorAll('.page');
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobile-menu');

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const pageId = button.dataset.page;
                showPage(pageId);
                if (mobileMenu.style.display === 'block') { 
                    mobileMenu.style.display = 'none';
                    mobileMenuButton.querySelector('svg.block').style.display = 'block';
                    mobileMenuButton.querySelector('svg.hidden').style.display = 'none';
                    mobileMenuButton.setAttribute('aria-expanded', 'false');
                }
            });
        });
        
        mobileMenuButton.addEventListener('click', () => {
            const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true' || false;
            mobileMenuButton.setAttribute('aria-expanded', !isExpanded);
            mobileMenu.style.display = isExpanded ? 'none' : 'block';
            mobileMenuButton.querySelector('svg.block').style.display = isExpanded ? 'block' : 'none';
            mobileMenuButton.querySelector('svg.hidden').style.display = isExpanded ? 'none' : 'block';
        });

        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            const activePage = document.getElementById(pageId);
            if (activePage) activePage.classList.add('active');

            navButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('text-indigo-200', 'hover:text-white', 'hover:bg-indigo-600');
                if (btn.dataset.page === pageId) {
                    btn.classList.add('active', 'bg-indigo-600', 'text-white');
                    btn.classList.remove('text-indigo-200');
                }
            });
            if (pageId === 'recipesPage') renderRecipeList();
            if (pageId === 'weekMenuPage') renderWeekMenuUI(); 
            if (pageId === 'groceriesPage') renderGroceriesList();
        }
        
        // --- MESSAGE BAR ---
        const messageBar = document.getElementById('messageBar');
        let messageTimeout;

        function showMessage(text, type = 'info', duration = 3000) {
            messageBar.textContent = text;
            messageBar.className = 'fixed bottom-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-md shadow-lg text-white z-50'; 
            if (type === 'success') messageBar.classList.add('bg-green-500');
            else if (type === 'error') messageBar.classList.add('bg-red-500');
            else messageBar.classList.add('bg-blue-500'); 
            
            messageBar.style.display = 'block';

            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                messageBar.style.display = 'none';
            }, duration);
        }

        // --- CSV PARSING ---
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r\n|\n/); // Handle both CRLF and LF line endings
            if (lines.length < 2) {
                console.warn("CSV has no data rows or only a header.");
                return []; 
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '')); // Trim and remove quotes from headers
            const dataRows = lines.slice(1);
            
            const parsedRecipes = [];

            dataRows.forEach((line, lineIndex) => {
                if (line.trim() === '') return; // Skip empty lines

                // Basic CSV splitting. This won't handle commas inside quoted fields perfectly.
                // For more robust CSV parsing, a library would be better.
                const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                
                if (values.length < headers.length) {
                    console.warn(`Skipping CSV row ${lineIndex + 2}: not enough columns. Expected ${headers.length}, got ${values.length}. Line: "${line}"`);
                    return;
                }

                const rowObject = {};
                headers.forEach((header, index) => {
                    rowObject[header] = values[index] || '';
                });

                if (!rowObject.recipeId || !rowObject.name) {
                    console.warn(`Skipping CSV row ${lineIndex + 2} due to missing recipeId or name:`, rowObject);
                    return; 
                }

                const recipe = {
                    recipeId: rowObject.recipeId,
                    name: rowObject.name,
                    defaultServings: parseInt(rowObject.defaultServings) || 1,
                    personalScore: rowObject.personalScore ? parseInt(rowObject.personalScore) : null,
                    ingredients: [],
                    procedure: []
                };

                for (let i = 1; i <= MAX_INGREDIENTS; i++) {
                    const ingName = rowObject[`ingredient${i}_name`];
                    if (ingName && ingName.trim() !== '') {
                        recipe.ingredients.push({
                            name: ingName,
                            quantity: parseFloat(rowObject[`ingredient${i}_quantity`]) || 0,
                            unit: rowObject[`ingredient${i}_unit`] || 'g',
                            calories_per_100: parseFloat(rowObject[`ingredient${i}_calories_per_100`]) || 0,
                            fat_per_100: parseFloat(rowObject[`ingredient${i}_fat_per_100`]) || 0,
                            saturatedFat_per_100: parseFloat(rowObject[`ingredient${i}_saturatedFat_per_100`]) || 0,
                            carbs_per_100: parseFloat(rowObject[`ingredient${i}_carbs_per_100`]) || 0,
                            sugars_per_100: parseFloat(rowObject[`ingredient${i}_sugars_per_100`]) || 0,
                            protein_per_100: parseFloat(rowObject[`ingredient${i}_protein_per_100`]) || 0,
                            salt_per_100: parseFloat(rowObject[`ingredient${i}_salt_per_100`]) || 0,
                        });
                    } else {
                        // If ingredient name is blank, assume no more ingredients for this recipe in this row
                        break; 
                    }
                }

                for (let i = 1; i <= MAX_PROCEDURE_STEPS; i++) {
                    const step = rowObject[`procedureStep${i}`];
                    if (step && step.trim() !== '') {
                        recipe.procedure.push(step);
                    } else {
                        // If step is blank, assume no more steps for this recipe in this row
                        break;
                    }
                }
                parsedRecipes.push(recipe);
            });
            return parsedRecipes;
        }


        // --- RECIPE CALCULATIONS ---
        function convertToGramsOrMl(quantity, unit) {
            const qty = parseFloat(quantity) || 0;
            const u = unit ? unit.toLowerCase() : '';
            if (u === 'kg' || u === 'l') {
                return qty * 1000;
            }
            return qty; 
        }

        function calculateRecipeNutritionPerServing(recipe) {
            const totals = { calories: 0, fat: 0, protein: 0, saturatedFat: 0, carbs: 0, sugars: 0, salt: 0 };
            if (!recipe.ingredients || recipe.ingredients.length === 0 || !recipe.defaultServings || recipe.defaultServings <= 0) {
                return totals;
            }

            recipe.ingredients.forEach(ing => {
                const ingredientQuantityInRecipe = convertToGramsOrMl(ing.quantity, ing.unit);
                totals.calories += (parseFloat(ing.calories_per_100) / 100) * ingredientQuantityInRecipe || 0;
                totals.fat += (parseFloat(ing.fat_per_100) / 100) * ingredientQuantityInRecipe || 0;
                totals.protein += (parseFloat(ing.protein_per_100) / 100) * ingredientQuantityInRecipe || 0;
                totals.saturatedFat += (parseFloat(ing.saturatedFat_per_100) / 100) * ingredientQuantityInRecipe || 0;
                totals.carbs += (parseFloat(ing.carbs_per_100) / 100) * ingredientQuantityInRecipe || 0;
                totals.sugars += (parseFloat(ing.sugars_per_100) / 100) * ingredientQuantityInRecipe || 0;
                totals.salt += (parseFloat(ing.salt_per_100) / 100) * ingredientQuantityInRecipe || 0;
            });

            for (const key in totals) {
                totals[key] = totals[key] / recipe.defaultServings;
            }
            return totals;
        }

        // --- RECIPES PAGE ---
        async function loadRecipesFromCSV() {
            document.getElementById('appLoader').style.display = 'flex';
            try {
                const response = await fetch(RECIPE_CSV_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} while fetching ${RECIPE_CSV_URL}`);
                }
                const csvText = await response.text();
                recipes = parseCSV(csvText);
                console.log("Recipes loaded from CSV:", recipes);
                if (recipes.length > 0) {
                    showMessage("Recipes loaded successfully!", "success");
                } else if (csvText.trim() !== '' && csvText.trim().split('\n').length >=1 ) { 
                     showMessage("Recipes loaded, but no valid recipe data found. Check CSV content and header.", "error", 7000);
                } else {
                     showMessage("CSV file might be empty or not formatted correctly.", "error", 7000);
                }
            } catch (error) {
                console.error("Error loading recipes from CSV: ", error);
                showMessage(`Error loading recipes: ${error.message}. Check CSV URL and format.`, "error", 7000);
                recipes = []; 
            } finally {
                renderRecipeList(); 
                if (document.getElementById('weekMenuPage')?.classList.contains('active')) {
                     renderWeekMenuUI(); 
                }
            }
        }

        function renderRecipeList() {
            const container = document.getElementById('recipeListContainer');
            if (!container) return;
            container.innerHTML = '';
            
            if (RECIPE_CSV_URL === 'YOUR_CSV_FILE_URL_HERE') {
                 container.innerHTML = '<p class="col-span-full text-center text-red-600 font-semibold py-8">ERROR: Please configure the RECIPE_CSV_URL in the HTML file first!</p>';
                 return;
            }
            if (recipes.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">No recipes found. Check your CSV file, the URL, or ensure it\'s publicly accessible and correctly formatted.</p>';
                return;
            }
            recipes.forEach(recipe => {
                const div = document.createElement('div');
                div.className = 'bg-white shadow-lg rounded-lg p-6 hover:shadow-xl transition-shadow duration-300';
                
                const nutrition = calculateRecipeNutritionPerServing(recipe);

                const ingredientsList = (recipe.ingredients && recipe.ingredients.length > 0)
                    ? recipe.ingredients.map(ing => {
                        let details = `${ing.name || 'Unnamed Ingredient'}: ${ing.quantity || '?'} ${ing.unit || ''}`;
                        return `<li>${details}</li>`;
                      }).join('')
                    : '<li>No ingredients listed.</li>';
                const procedureList = (recipe.procedure && recipe.procedure.length > 0)
                    ? recipe.procedure.map(step => `<li>${step || 'No description'}</li>`).join('')
                    : '<li>No procedure steps listed.</li>';

                let totalRecipeNutrition = { calories: 0, fat: 0, saturatedFat: 0, carbs: 0, sugars: 0, protein: 0, salt: 0 };
                if (recipe.ingredients && recipe.defaultServings > 0) {
                    recipe.ingredients.forEach(ing => {
                        const ingredientQuantityInRecipe = convertToGramsOrMl(ing.quantity, ing.unit);
                        totalRecipeNutrition.calories += (parseFloat(ing.calories_per_100) / 100) * ingredientQuantityInRecipe || 0;
                        totalRecipeNutrition.fat += (parseFloat(ing.fat_per_100) / 100) * ingredientQuantityInRecipe || 0;
                        totalRecipeNutrition.saturatedFat += (parseFloat(ing.saturatedFat_per_100) / 100) * ingredientQuantityInRecipe || 0;
                        totalRecipeNutrition.carbs += (parseFloat(ing.carbs_per_100) / 100) * ingredientQuantityInRecipe || 0;
                        totalRecipeNutrition.sugars += (parseFloat(ing.sugars_per_100) / 100) * ingredientQuantityInRecipe || 0;
                        totalRecipeNutrition.protein += (parseFloat(ing.protein_per_100) / 100) * ingredientQuantityInRecipe || 0;
                        totalRecipeNutrition.salt += (parseFloat(ing.salt_per_100) / 100) * ingredientQuantityInRecipe || 0;
                    });
                }

                div.innerHTML = `
                    <h3 class="text-xl font-semibold text-indigo-700 mb-2">${recipe.name || 'Unnamed Recipe'}</h3>
                    <p class="text-sm text-gray-600"><strong>Serves:</strong> ${recipe.defaultServings || 'N/A'}</p>
                    <p class="text-sm text-gray-600"><strong>Calories:</strong> ${nutrition.calories.toFixed(0)} kcal/serving</p>
                    <p class="text-sm text-gray-600"><strong>Fat:</strong> ${nutrition.fat.toFixed(1)} g/serving (Sat: ${nutrition.saturatedFat.toFixed(1)}g)</p>
                    <p class="text-sm text-gray-600"><strong>Carbs:</strong> ${nutrition.carbs.toFixed(1)} g/serving (Sugars: ${nutrition.sugars.toFixed(1)}g)</p>
                    <p class="text-sm text-gray-600"><strong>Protein:</strong> ${nutrition.protein.toFixed(1)} g/serving</p>
                    <p class="text-sm text-gray-600"><strong>Salt:</strong> ${nutrition.salt.toFixed(2)} g/serving</p>
                    ${recipe.personalScore ? `<p class="text-sm text-gray-600"><strong>Personal Score:</strong> ${recipe.personalScore}/10</p>` : ''}
                    
                    <details class="mt-3 text-sm">
                        <summary class="font-medium text-indigo-600 cursor-pointer">Ingredients & Full Recipe Nutrition</summary>
                        <ul class="list-disc list-inside mt-1 text-gray-700">
                            ${ingredientsList}
                        </ul>
                         <div class="mt-2 text-xs border-t pt-2">
                            <h4 class="font-semibold">Totals for entire recipe (makes ${recipe.defaultServings || 'N/A'} servings):</h4>
                            <p>Total Calories: ${totalRecipeNutrition.calories.toFixed(0)} kcal</p>
                            <p>Total Fat: ${totalRecipeNutrition.fat.toFixed(1)}g (Saturated: ${totalRecipeNutrition.saturatedFat.toFixed(1)}g)</p>
                            <p>Total Carbs: ${totalRecipeNutrition.carbs.toFixed(1)}g (Sugars: ${totalRecipeNutrition.sugars.toFixed(1)}g)</p>
                            <p>Total Protein: ${totalRecipeNutrition.protein.toFixed(1)}g</p>
                            <p>Total Salt: ${totalRecipeNutrition.salt.toFixed(2)}g</p>
                        </div>
                    </details>
                    <details class="mt-2 text-sm">
                        <summary class="font-medium text-indigo-600 cursor-pointer">Procedure</summary>
                        <ol class="list-decimal list-inside mt-1 text-gray-700 space-y-1">
                            ${procedureList}
                        </ol>
                    </details>
                `;
                container.appendChild(div);
            });
        }

        // --- WEEK MENU PAGE ---
        const numDaysSelect = document.getElementById('numDays');
        const weekMenuDaysContainer = document.getElementById('weekMenuDaysContainer');

        function setupNumDaysListener() {
            if(numDaysSelect) {
                numDaysSelect.addEventListener('change', () => {
                    weekMenu.numDays = parseInt(numDaysSelect.value);
                    renderWeekMenuUI();
                    saveWeekMenuToLocalStorage(); 
                });
            }
        }

        function loadWeekMenuFromLocalStorage() {
            const savedMenu = localStorage.getItem(WEEK_MENU_LOCALSTORAGE_KEY);
            if (savedMenu) {
                try {
                    weekMenu = JSON.parse(savedMenu);
                    console.log("Week menu loaded from localStorage:", weekMenu);
                } catch (e) {
                    console.error("Error parsing week menu from localStorage", e);
                    weekMenu = { numDays: 5, days: {} }; 
                }
            } else {
                console.log("No week menu found in localStorage, using default.");
                weekMenu = { numDays: 5, days: {} }; 
            }
            if(numDaysSelect) numDaysSelect.value = weekMenu.numDays; 
            renderWeekMenuUI();
        }
        
        function renderWeekMenuUI() {
            if (!weekMenuDaysContainer) return;
            
            if (recipes.length === 0 && Object.keys(weekMenu.days).length === 0) {
                weekMenuDaysContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Load some recipes from CSV first to plan your week!</p>`;
                return;
            }
            
            weekMenuDaysContainer.innerHTML = ''; 

            for (let i = 0; i < weekMenu.numDays; i++) {
                const dayId = `day${i}`;
                const dayData = weekMenu.days[dayId] || {};
                let dailyTotalCalories = 0;

                const dayElement = document.createElement('div');
                dayElement.className = 'bg-white shadow rounded-lg p-6 space-y-4';
                
                let mealSlotsHTML = '';
                mealTypes.forEach(meal => {
                    const mealData = dayData[meal] || { recipeId: '', servings: 1 };
                    const selectedRecipe = recipes.find(r => r.recipeId === mealData.recipeId); 
                    let mealCalories = 0;
                    if (selectedRecipe && mealData.servings > 0) {
                        const recipeNutritionPerServing = calculateRecipeNutritionPerServing(selectedRecipe);
                        mealCalories = recipeNutritionPerServing.calories * mealData.servings;
                        dailyTotalCalories += mealCalories;
                    }

                    mealSlotsHTML += `
                        <div class="meal-slot border-t pt-3 mt-3 first:mt-0 first:border-t-0">
                            <label for="${dayId}_${meal}_recipe" class="block text-sm font-medium text-gray-700">${meal.charAt(0).toUpperCase() + meal.slice(1)} (${mealCalories.toFixed(0)} kcal)</label>
                            <div class="flex space-x-2 mt-1">
                                <select id="${dayId}_${meal}_recipe" data-day="${i}" data-meal="${meal}" class="recipe-select mt-1 block w-2/3">
                                    <option value="">-- Select Recipe --</option>
                                    ${recipes.map(r => `<option value="${r.recipeId}" ${r.recipeId === mealData.recipeId ? 'selected' : ''}>${r.name || 'Unnamed Recipe'}</option>`).join('')}
                                </select>
                                <input type="number" id="${dayId}_${meal}_servings" data-day="${i}" data-meal="${meal}" value="${mealData.servings || 1}" min="1" class="servings-input mt-1 block w-1/3" placeholder="Servings">
                            </div>
                        </div>
                    `;
                });
                
                dayElement.innerHTML = `
                    <h3 class="text-xl font-semibold text-indigo-700">${dayNames[i]} 
                        <span id="${dayId}_total_calories" class="text-base font-normal text-gray-600">(Total: ${dailyTotalCalories.toFixed(0)} kcal)</span>
                    </h3>
                    ${mealSlotsHTML}
                `;
                weekMenuDaysContainer.appendChild(dayElement);
            }
            
            weekMenuDaysContainer.querySelectorAll('.recipe-select, .servings-input').forEach(input => {
                input.addEventListener('change', handleMenuChange);
            });
        }

        function handleMenuChange(event) {
            const target = event.target;
            const dayIndex = parseInt(target.dataset.day);
            const mealType = target.dataset.meal;
            const dayId = `day${dayIndex}`;

            if (!weekMenu.days[dayId]) weekMenu.days[dayId] = {};
            if (!weekMenu.days[dayId][mealType]) weekMenu.days[dayId][mealType] = { recipeId: '', servings: 1 };

            if (target.classList.contains('recipe-select')) {
                weekMenu.days[dayId][mealType].recipeId = target.value;
            } else if (target.classList.contains('servings-input')) {
                weekMenu.days[dayId][mealType].servings = parseInt(target.value) || 1;
            }
            
            updateDailyCaloriesDisplay(dayIndex);
            saveWeekMenuToLocalStorage();
        }

        function updateDailyCaloriesDisplay(dayIndex) {
            const dayId = `day${dayIndex}`;
            let dailyTotalCalories = 0;

            mealTypes.forEach(mealType => {
                const mealLabel = weekMenuDaysContainer.querySelector(`#${dayId}_${mealType}_recipe`)?.closest('.meal-slot')?.querySelector('label');
                const recipeId = weekMenu.days[dayId]?.[mealType]?.recipeId;
                const servings = weekMenu.days[dayId]?.[mealType]?.servings || 0;
                
                let mealCalories = 0;
                if (recipeId && servings > 0) {
                    const recipe = recipes.find(r => r.recipeId === recipeId);
                    if (recipe) {
                        const recipeNutritionPerServing = calculateRecipeNutritionPerServing(recipe);
                        mealCalories = recipeNutritionPerServing.calories * servings;
                        dailyTotalCalories += mealCalories;
                    }
                }
                if(mealLabel) mealLabel.textContent = `${mealType.charAt(0).toUpperCase() + mealType.slice(1)} (${mealCalories.toFixed(0)} kcal)`;
            });
            
            const totalCaloriesDisplay = document.getElementById(`${dayId}_total_calories`);
            if (totalCaloriesDisplay) {
                totalCaloriesDisplay.textContent = `(Total: ${dailyTotalCalories.toFixed(0)} kcal)`;
            }
        }
        
        function saveWeekMenuToLocalStorage() {
            try {
                localStorage.setItem(WEEK_MENU_LOCALSTORAGE_KEY, JSON.stringify(weekMenu));
                console.log("Week menu saved to localStorage:", weekMenu);
            } catch (error) {
                console.error("Error saving week menu to localStorage: ", error);
                showMessage("Error saving week menu.", "error");
            }
        }

        // --- GROCERIES PAGE ---
        const generateGroceriesBtn = document.getElementById('generateGroceriesFromMenuBtn');
        if (generateGroceriesBtn) {
            generateGroceriesBtn.addEventListener('click', () => {
                renderGroceriesList();
                showPage('groceriesPage');
            });
        }

        function renderGroceriesList() {
            const container = document.getElementById('groceriesListContainer');
            if (!container) return;
            container.innerHTML = '';
            
            const aggregatedIngredients = {}; 

            for (const dayKey in weekMenu.days) {
                const dayData = weekMenu.days[dayKey];
                for (const mealType in dayData) {
                    const mealInfo = dayData[mealType];
                    if (mealInfo && mealInfo.recipeId && mealInfo.servings > 0) {
                        const recipe = recipes.find(r => r.recipeId === mealInfo.recipeId); 
                        if (recipe && recipe.ingredients && recipe.defaultServings > 0) { 
                            const scaleFactor = mealInfo.servings / recipe.defaultServings;
                            recipe.ingredients.forEach(ing => {
                                if (ing.name && ing.unit && typeof ing.quantity === 'number') { 
                                    const key = `${ing.name.toLowerCase().trim()}_${ing.unit.toLowerCase().trim()}`;
                                    const scaledQuantity = ing.quantity * scaleFactor;
                                    if (aggregatedIngredients[key]) {
                                        aggregatedIngredients[key].quantity += scaledQuantity;
                                    } else {
                                        aggregatedIngredients[key] = {
                                            name: ing.name,
                                            quantity: scaledQuantity,
                                            unit: ing.unit
                                        };
                                    }
                                }
                            });
                        }
                    }
                }
            }

            if (Object.keys(aggregatedIngredients).length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">No recipes selected in the Week Menu, or selected recipes have no ingredients. Plan your week first!</p>';
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'list-disc list-inside space-y-2 text-gray-700';
            for (const key in aggregatedIngredients) {
                const item = aggregatedIngredients[key];
                const li = document.createElement('li'); 
                let displayQuantity = parseFloat(item.quantity.toFixed(2));
                li.innerHTML = `<span class="font-medium">${item.name}:</span> ${displayQuantity} ${item.unit}`;
                ul.appendChild(li);
            }
            container.appendChild(ul);
        }

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', initializeAppState);

    </script>
</body>
</html>
